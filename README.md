# ì´ë²¤íŠ¸ ë° ë³´ìƒ ê´€ë¦¬ í”Œë«í¼

![poster](./assets/imgs/image.png)

## ğŸ‘‹ ì†Œê°œ

ì´ë²¤íŠ¸ ë° ë³´ìƒ ê´€ë¦¬ í”Œë«í¼(NERS) í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.
NestJSì™€ MSA(Microservice Architecture), MongoDBë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì„¤ê³„ ë° êµ¬í˜„ë˜ì—ˆìŠµë‹ˆë‹¤.

DDD(Domain-Driven Design)ì˜ ì›ì¹™ì„ ì¼ë¶€ ì ìš©í•˜ì—¬ ë„ë©”ì¸ ë¡œì§ì˜ ëª…í™•ì„±ê³¼ ì‹œìŠ¤í…œì˜ ìœ ì§€ë³´ìˆ˜ì„±ì„ ë†’ì´ê³ ì ë…¸ë ¥í–ˆìŠµë‹ˆë‹¤.

## ğŸš€ ì‹¤í–‰ ë°©ë²• (Docker Compose)

1. .env.example íŒŒì¼ì„ .envíŒŒì¼ë¡œ ë³µì‚¬í•©ë‹ˆë‹¤.
1. í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ë¹Œë“œí•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤.
   ```bash
   docker-compose up --build
   ```
1. API ë¬¸ì„œëŠ” ê° ì„œë¹„ìŠ¤ì˜ `/api` ê²½ë¡œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì˜ˆ: `http://localhost:3000/api` - Auth Server).

## íë¦„ë„

```
+-----------+                                 +-----------------+
|  Client   | --1. API Request (with JWT)--> |  Gateway Server |
+-----------+                                 +-----------------+
                                                    |
                                                    | 2. JWT ê²€ì¦ (ì„œëª…, ë§Œë£Œ)
                                                    |    (Gateway ìì²´ ìˆ˜í–‰)
                                                    |
                                                    | 3. ì—­í•  ê²€ì‚¬ (í•„ìš”ì‹œ)
                                                    |    (Gateway ìì²´ ìˆ˜í–‰, JWT ë‚´ role ì •ë³´ ì‚¬ìš©)
                                                    |
                                       (ì„±ê³µ ì‹œ)    V
                            +--------------------------------------+
                            | 4. ë¼ìš°íŒ… & í”„ë¡ì‹œ                     |
                            +------------------+-------------------+
                                               | (ìš”ì²­ ì¢…ë¥˜ì— ë”°ë¼)
                                               V
+-----------------+                  +-----------------+
|   Auth Server   | <--(ì˜ˆ: /users/me) |  Event Server   | <--(ì˜ˆ: /events)
+-----------------+                  +-----------------+
    ^ (ì‘ë‹µ)                               ^ (ì‘ë‹µ)
    |                                      |
    +-----------(ì‘ë‹µ)--------------------(ì‘ë‹µ)-----------+
                                                    |
                                                    V
                                              (ì‘ë‹µ ì „ë‹¬)
+-----------+                                 +-----------------+
|  Client   | <---6. API Response------------ |  Gateway Server |
+-----------+                                 +-----------------+

```

## ğŸ§± ê¸°ìˆ  ìŠ¤íƒ

- **Node.js:** v18 (ê³ ì •)
- **Framework:** NestJS (ìµœì‹  ë²„ì „)
- **Language:** TypeScript
- **Database:** MongoDB
- **Authentication:** JWT (JSON Web Token) - Access Token & Refresh Token ë°©ì‹
- **API Documentation:** Swagger (OpenAPI)
- **Deployment/Runtime:** Docker, Docker Compose

## ì°¸ê³ ì‚¬í•­

- gateway-server, auth-server, event-serverëŠ” nestjs monorepoë¥¼ ì´ìš©í•˜ì˜€ìŠµë‹ˆë‹¤.
- ìœ ì €ê°€ ë³´ìƒ ì—¬ê±´ì´ ì¶©ì¡±í–ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ì„œ ìœ ì € í–‰ë™ ê°’ì€ ì„ì˜ ìƒì„±í•˜ì˜€ìŠµë‹ˆë‹¤. `getMockUserActivityData`í•¨ìˆ˜
- gateway-serverì˜ swaggeríŒŒì¼ì„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - ì„œë¹„ìŠ¤ ì‹¤í–‰ í›„ http://localhost:3000/api
  - auth-server, event-serverì˜ apië¥¼ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- access token ìœ íš¨ì‹œê°„ì€ 1ì‹œê°„ì…ë‹ˆë‹¤.

## ğŸ§© ì„œë²„ êµ¬ì„± ë° ì—­í• 

ë³¸ í”„ë¡œì íŠ¸ëŠ” 3ê°œì˜ ì„œë²„ë¡œ êµ¬ì„±ëœ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ë¥¼ ë”°ë¦…ë‹ˆë‹¤.

1.  **Gateway Server (`gateway-server`):**

    - ëª¨ë“  API ìš”ì²­ì˜ ë‹¨ì¼ ì§„ì…ì (Single Entry Point).
    - JWT ê¸°ë°˜ ì¸ì¦ ë° ì—­í• (Role) ê¸°ë°˜ ì¸ê°€ ìˆ˜í–‰.
    - ìš”ì²­ ê²½ë¡œì— ë”°ë¼ ì ì ˆí•œ ë°±ì—”ë“œ ì„œë¹„ìŠ¤(Auth, Event)ë¡œ ë¼ìš°íŒ… (HTTP Proxy).

2.  **Auth Server (`auth-server`):**

    - ì‚¬ìš©ì ê³„ì • ê´€ë¦¬ (íšŒì›ê°€ì…, ë¡œê·¸ì¸).
    - JWT (Access Token, Refresh Token) ë°œê¸‰, ì…”ì‹ , ë¬´íš¨í™” ê´€ë¦¬.
    - ì‚¬ìš©ì ì—­í• (Role) ê´€ë¦¬ ê¸°ëŠ¥ ì œê³µ (ADMIN ê¶Œí•œ).
    - **ë„ë©”ì¸:** account

3.  **Event Server (`event-server`):**
    - ì´ë²¤íŠ¸ ìƒì„±, ì¡°íšŒ, ìˆ˜ì •, ìƒíƒœ ë³€ê²½ ê´€ë¦¬ (ìš´ì˜ì/ê´€ë¦¬ì).
    - ì´ë²¤íŠ¸ì— ì—°ê²°ëœ ë³´ìƒ ì •ë³´ ì •ì˜ ë° ê´€ë¦¬ (ìš´ì˜ì/ê´€ë¦¬ì).
    - ì‚¬ìš©ìì˜ ë³´ìƒ ìš”ì²­ ì²˜ë¦¬ ë° ì¡°ê±´ ê²€ì¦.
    - ë³´ìƒ ì§€ê¸‰ ìƒíƒœ ì €ì¥ ë° ìš”ì²­ ë‚´ì—­ ì¡°íšŒ ê¸°ëŠ¥.
    - **ë„ë©”ì¸:** Event, Reward, Reward Request

## ğŸ”§ ê¸°ëŠ¥ ìƒì„¸

### Gateway Server

- **ì¸ì¦/ì¸ê°€:**
  - `@nestjs/passport`, `passport-jwt`ë¥¼ ì‚¬ìš©í•œ JWT Access Token ê²€ì¦.
  - `RolesGuard`ë¥¼ í†µí•œ ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´.
  - `@Public()` ë°ì½”ë ˆì´í„°ë¥¼ í†µí•´ ì¸ì¦ ì—†ì´ ì ‘ê·¼ ê°€ëŠ¥í•œ API ì§€ì •.
- **ë¼ìš°íŒ…:**
  - ìš”ì²­ URL íŒ¨í„´(` /auth/**`, `/events/**` ë“±)ì— ë”°ë¼ Auth Server ë˜ëŠ” Event Serverë¡œ í”„ë¡ì‹œ.
  - ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´(ID, ì—­í•  ë“±)ë¥¼ ì»¤ìŠ¤í…€ HTTP í—¤ë”(`X-User-ID`, `X-User-Role`)ì— ë‹´ì•„ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë¡œ ì „ë‹¬.

### Auth Server (IAM Domain)

- **ì‚¬ìš©ì (User):**
  - `POST /auth/register`: ì‚¬ìš©ì ë“±ë¡ (ë¹„ë°€ë²ˆí˜¸ëŠ” bcryptë¡œ í•´ì‹±í•˜ì—¬ ì €ì¥).
  - `User` ì—”í‹°í‹°, `UsernameVO`, `PasswordVO` (Plain/Hashed), `RoleVO` ë“± ê°’ ê°ì²´ ì‚¬ìš©.
- **ì¸ì¦ (Authentication):**
  - `POST /auth/login`: ë¡œê·¸ì¸ ì„±ê³µ ì‹œ Access Token ë° Refresh Token ë°œê¸‰.
  - `POST /auth/refresh`: ìœ íš¨í•œ Refresh Tokenìœ¼ë¡œ ìƒˆë¡œìš´ Access Token (ë° Refresh Token) ë°œê¸‰ (Refresh Token Rotation ì ìš©).
  - `POST /auth/logout`: Refresh Token ë¬´íš¨í™” ì²˜ë¦¬.
  - Refresh Tokenì€ DBì— ì €ì¥í•˜ì—¬ ê´€ë¦¬ (ì„ íƒì  ë¬´íš¨í™”, ì„¸ì…˜ ê´€ë¦¬).
- **ì—­í•  (Role):**
  - ì •ì˜ëœ ì—­í• : `USER`, `OPERATOR`, `AUDITOR`, `ADMIN`.
  - `PATCH /users/{userId}/role` (ADMIN): íŠ¹ì • ì‚¬ìš©ìì˜ ì—­í•  ë³€ê²½.
  - ì—­í•  ë³€ê²½ ì‹œ, í•´ë‹¹ ì‚¬ìš©ìì˜ ê¸°ì¡´ Refresh Tokenì„ ë¬´íš¨í™”í•˜ì—¬ ë‹¤ìŒ í† í° ê°±ì‹  ì‹œ ë³€ê²½ëœ ì—­í• ì´ ì ìš©ë˜ë„ë¡ ìœ ë„.
- **ì‚¬ìš©ì ì •ë³´:**
  - `GET /users/me`: ë¡œê·¸ì¸í•œ ìì‹ ì˜ ì •ë³´ ì¡°íšŒ.
  - `GET /users` (ADMIN): ì „ì²´ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ.

### Event Server

#### 1. ì´ë²¤íŠ¸ (Event) ë„ë©”ì¸

- **ê¸°ëŠ¥:**
  - `POST /events` (OPERATOR, ADMIN): ìƒˆ ì´ë²¤íŠ¸ ìƒì„±.
    - ì´ë¦„, ì„¤ëª…, ê¸°ê°„, ìƒíƒœ, ì¡°ê±´, ìƒì„±ì ì •ë³´ í¬í•¨.
    - `conditions`: ë‹¤ì–‘í•œ ì´ë²¤íŠ¸ ì¡°ê±´(ì˜ˆ: `LOGIN_STREAK`, `USER_LEVEL`)ì„ ìœ ì—°í•˜ê²Œ ì •ì˜í•  ìˆ˜ ìˆëŠ” êµ¬ì¡°. `EventConditionDto`ì˜ `parameters` ê°ì²´ë¥¼ í†µí•´ íƒ€ì…ë³„ ìƒì„¸ ì¡°ê±´ ì…ë ¥.
  - `GET /events`, `GET /events/{eventId}`: ì´ë²¤íŠ¸ ëª©ë¡ ë° ìƒì„¸ ì¡°íšŒ.
  - `PUT /events/{eventId}` (OPERATOR, ADMIN): ì´ë²¤íŠ¸ ì •ë³´ ìˆ˜ì •.
  - `PATCH /events/{eventId}/status` (OPERATOR, ADMIN): ì´ë²¤íŠ¸ ìƒíƒœ ë³€ê²½ (ì˜ˆ: `ACTIVE`, `INACTIVE`, `COMPLETED`).

#### 2. ë³´ìƒ (Reward) ë„ë©”ì¸

- **ê¸°ëŠ¥:**
  - `POST /events/{eventId}/rewards` (OPERATOR, ADMIN): íŠ¹ì • ì´ë²¤íŠ¸ì— ë³´ìƒ ì •ë³´ ì¶”ê°€.
    - ë³´ìƒ ìœ í˜•(`type`), ìƒì„¸ ë‚´ìš©(`details`)
  - `GET /events/{eventId}/rewards`: íŠ¹ì • ì´ë²¤íŠ¸ì˜ ë³´ìƒ ëª©ë¡ ì¡°íšŒ.
  - `PUT /rewards/{rewardId}` (OPERATOR, ADMIN): ë³´ìƒ ì •ë³´ ìˆ˜ì •.

#### 3. ë³´ìƒ ìš”ì²­ (RewardRequest) ë„ë©”ì¸

- **ê¸°ëŠ¥:**
  - `POST /reward-requests` (USER): ì‚¬ìš©ìê°€ íŠ¹ì • ì´ë²¤íŠ¸ì— ëŒ€í•´ ë³´ìƒ ìš”ì²­.
    - **ì¤‘ë³µ ë³´ìƒ ìš”ì²­ ë°©ì§€:** `userId` + `eventId` (+ `rewardId`) ê¸°ì¤€ìœ¼ë¡œ `RewardRequest` í…Œì´ë¸”ì„ ì¡°íšŒí•˜ì—¬, ì´ë¯¸ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ëœ (`APPROVED`, `CLAIMED`) ìš”ì²­ì´ ìˆëŠ”ì§€ í™•ì¸.
    - **ì¡°ê±´ ì¶©ì¡± ì—¬ë¶€ ê²€ì¦ (`checkEventConditions`):**
      - `EventConditionsVO`ì— ì •ì˜ëœ ì¡°ê±´ê³¼ ì‚¬ìš©ìì˜ ì‹¤ì œ í™œë™ ë°ì´í„°(Mock ë˜ëŠ” ê°€ìƒ ë°ì´í„° ì†ŒìŠ¤)ë¥¼ ë¹„êµí•˜ì—¬ ê²€ì¦.
      - ì¡°ê±´ ê²€ì¦ ë¡œì§ì€ ìœ ì—°í•˜ê²Œ í™•ì¥ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„ (ì˜ˆ: ì¡°ê±´ ìœ í˜•ë³„ ì²˜ë¦¬).
    - ì¡°ê±´ ë¯¸ì¶©ì¡± ë˜ëŠ” ì¤‘ë³µ ì‹œ `REJECTED_...` ìƒíƒœë¡œ ê¸°ë¡.
    - ì¡°ê±´ ì¶©ì¡± ì‹œ `APPROVED` ìƒíƒœë¡œ ê¸°ë¡ ë° (ê°€ìƒ) ë³´ìƒ ì§€ê¸‰ ì²˜ë¦¬ (ì˜ˆ: `Reward` ì—”í‹°í‹°ì˜ `remainingQuantity` ì°¨ê°).
  - `GET /reward-requests/me` (USER): ìì‹ ì˜ ë³´ìƒ ìš”ì²­ ë‚´ì—­ ì¡°íšŒ.
  - `GET /reward-requests` (OPERATOR, AUDITOR, ADMIN): ì „ì²´ ì‚¬ìš©ìì˜ ë³´ìƒ ìš”ì²­ ê¸°ë¡ ì¡°íšŒ (í•„í„°ë§ ê¸°ëŠ¥ ì„ íƒì  êµ¬í˜„).

## ğŸ” ì¸ì¦ ë° ì¸ê°€ êµ¬ì¡°

- **ì¸ì¦ (Authentication):**
  - ë¡œê·¸ì¸ ì‹œ JWT Access Token(ë‹¨ê¸°)ê³¼ Refresh Token(ì¥ê¸°, DB ì €ì¥) ë°œê¸‰.
  - API ìš”ì²­ ì‹œ `Authorization: Bearer <AccessToken>` í—¤ë” ì‚¬ìš©.
  - Gateway Serverì—ì„œ Access Token ìœ íš¨ì„±(ì„œëª…, ë§Œë£Œ) ê²€ì¦.
  - Access Token ë§Œë£Œ ì‹œ, í´ë¼ì´ì–¸íŠ¸ëŠ” Refresh Tokenì„ ì‚¬ìš©í•˜ì—¬ ìƒˆë¡œìš´ Access Token ìš”ì²­.
- **ì¸ê°€ (Authorization):**
  - Gateway Serverì˜ `RolesGuard`ê°€ JWT í˜ì´ë¡œë“œ ë‚´ì˜ `role` ì •ë³´ì™€ ê° APIì— í•„ìš”í•œ ì—­í• ì„ ë¹„êµí•˜ì—¬ ì ‘ê·¼ ì œì–´.
  - Auth Serverì™€ Event Serverì˜ ì¤‘ìš” APIì—ë„ ìì²´ì ì¸ `RolesGuard`ë¥¼ ë‘ì–´ ì‹¬ì¸µ ë°©ì–´ (Defense in Depth).

## ğŸ“‚ DDD í´ë” ë° íŒŒì¼ êµ¬ì¡°

```
.
â”œâ”€â”€ apps
â”‚   â”œâ”€â”€ auth-server
â”‚   â”‚   â”œâ”€â”€ src
â”‚   â”‚   â”‚   â””â”€â”€ account
â”‚   â”‚   â”‚       â”œâ”€â”€ application
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ service
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ use-cases
â”‚   â”‚   â”‚       â”œâ”€â”€ domain
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ entites
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ repositories
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ value-objects
â”‚   â”‚   â”‚       â””â”€â”€ infrastructure
â”‚   â”‚   â”‚           â”œâ”€â”€ controller
â”‚   â”‚   â”‚           â””â”€â”€ repositories
â”‚   â”‚   â”‚               â””â”€â”€ schemas
â”‚   â”‚   â””â”€â”€ test
â”‚   â”œâ”€â”€ event-server
â”‚   â”‚   â”œâ”€â”€ src
â”‚   â”‚   â”‚   â”œâ”€â”€ common
â”‚   â”‚   â”‚   â”œâ”€â”€ event
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ application
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ use-cases
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ domain
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ entites
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ value-objects
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ schemas
â”‚   â”‚   â”‚   â”œâ”€â”€ reward
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ application
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ use-cases
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ domain
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ entites
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ value-objects
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ schemas
â”‚   â”‚   â”‚   â””â”€â”€ reward-request
â”‚   â”‚   â”‚       â””â”€â”€ schemas
â”‚   â”‚   â””â”€â”€ test
â”‚   â””â”€â”€ gateway-server
â”‚       â”œâ”€â”€ src
â”‚       â”‚   â”œâ”€â”€ auth
â”‚       â”‚   â””â”€â”€ proxy
â””â”€â”€     â””â”€â”€ test
```

- **ë„ë©”ì¸ ì—”í‹°í‹°:** ìˆœìˆ˜ TypeScript í´ë˜ìŠ¤ë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í¬í•¨.
- **ê°’ ê°ì²´ (VO):** ë¶ˆë³€ì„±ì„ ê°€ì§€ë©° íŠ¹ì • ê°’ê³¼ ê´€ë ¨ëœ ê·œì¹™ ìº¡ìŠí™”.
- **ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤:** ìœ ìŠ¤ì¼€ì´ìŠ¤ ì¡°ì •, DTO-ì—”í‹°í‹° ë³€í™˜, íŠ¸ëœì­ì…˜ ê´€ë¦¬.
- **ë¦¬í¬ì§€í† ë¦¬:** ì¸í„°í˜ì´ìŠ¤ëŠ” ë„ë©”ì¸ ê³„ì¸µì—, êµ¬í˜„ì²´ëŠ” ì¸í”„ë¼ìŠ¤íŠ¸ëŸ­ì²˜ ê³„ì¸µì— ìœ„ì¹˜.
